name: Build Android TCC (Docker)
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: cirrusci/android-sdk:30

    steps:
      - name: Checkout TCC
        run: |
          # Install basic tools that might be missing in the container
          apt-get update && apt-get install -y git gcc make
          git clone --depth 1 https://repo.or.cz/tinycc.git .

      - name: Compile TCC
        run: |
          # 1. FIND the NDK path automatically
          # This removes the "path not found" error
          NDK_ROOT=$(find / -name "ndk" -type d -print -quit 2>/dev/null || find / -name "ndk-bundle" -type d -print -quit 2>/dev/null)
          echo "Found NDK at: $NDK_ROOT"
          
          # 2. Setup Toolchain
          TOOLCHAIN=$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64
          CROSS=$TOOLCHAIN/bin/aarch64-linux-android21-
          
          # 3. Configure
          ./configure \
            --cpu=aarch64 \
            --cc=${CROSS}clang \
            --ar=${CROSS}llvm-ar \
            --extra-cflags="-fPIC" \
            --extra-ldflags="-static"

          # 4. FIX the c2str error by building it for the container host
          gcc -O2 conftest.c -o c2str.exe
          ./c2str.exe include/tccdefs.h tccdefs_.h
          
          # 5. Build
          make

          # 6. Prepare libtcc.so for JNI
          cp tcc libtcc.so
          ${CROSS}llvm-strip libtcc.so

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tcc-final-binary
          path: |
            libtcc.so
            include/*.h
            
