name: Build TinyCC for Android

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      TCC_VERSION: 0.9.27
      ANDROID_ABI: arm64-v8a
      ANDROID_API: 21

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            wget \
            tar \
            python3

      - name: Download Android NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip android-ndk-r26d-linux.zip
          echo "NDK_HOME=$PWD/android-ndk-r26d" >> $GITHUB_ENV

      - name: Download TinyCC source
        run: |
          wget https://download.savannah.gnu.org/releases/tinycc/tcc-${TCC_VERSION}.tar.bz2
          tar -xf tcc-${TCC_VERSION}.tar.bz2

      - name: Configure TinyCC for Android
        run: |
          export TOOLCHAIN=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
          export TARGET=aarch64-linux-android
          export API=${ANDROID_API}

          export CC=$TOOLCHAIN/bin/${TARGET}${API}-clang
          export AR=$TOOLCHAIN/bin/llvm-ar
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip

          cd tcc-${TCC_VERSION}

          ./configure \
            --cross-prefix=${TARGET}- \
            --cc="$CC" \
            --ar="$AR" \
            --ranlib="$RANLIB" \
            --strip="$STRIP" \
            --cpu=arm64 \
            --enable-shared \
            --prefix=/usr

      - name: Build TinyCC
        run: |
          cd tcc-${TCC_VERSION}
          make -j$(nproc)

      - name: Collect artifacts
        run: |
          mkdir -p output/lib output/include

          cp tcc-${TCC_VERSION}/libtcc.so output/lib/
          cp -r tcc-${TCC_VERSION}/include/* output/include/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tcc-android-arm64
          path: output
          
