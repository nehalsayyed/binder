name: Build Linux Kernel (allyesconfig, x86_64)

on:
  workflow_dispatch:
  
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install full build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            flex \
            bison \
            libncurses-dev \
            libssl-dev \
            bc \
            wget \
            git \
            ccache \
            pkg-config \
            libelf-dev \
            dwarves \
            zlib1g-dev \
            liblz4-dev \
            libzstd-dev \
            libcap-dev \
            libattr1-dev \
            python3 \
            python3-pip \
            rsync \
            tar \
            xz-utils \
            gzip \
            lzop \
            libudev-dev \
            libpci-dev \
            libiberty-dev \
            libdw-dev \
            libnuma-dev \
            libmount-dev \
            libseccomp-dev \
            libselinux1-dev \
            libgnutls28-dev \
            libreadline-dev \
            libgmp-dev \
            libmpfr-dev \
            libisl-dev \
            libcloog-isl-dev

      - name: Download Linux kernel
        run: |
          git clone --depth=1 https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
          cd linux
          echo "Linux kernel source downloaded"

      - name: Configure kernel (allyesconfig for x86_64)
        run: |
          cd linux
          make ARCH=x86_64 mrproper
          make ARCH=x86_64 allyesconfig

      - name: Build kernel (x86_64)
        run: |
          cd linux
          make ARCH=x86_64 -j$(nproc)

      - name: Package artifacts
        run: |
          cd linux
          tar -cvJf ../linux-x86_64-build.tar.xz \
            arch/x86/boot/ \
            vmlinux \
            .config

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-kernel-build-x86_64
          path: linux-x86_64-build.tar.xz
