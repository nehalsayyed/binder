name: Manual Android 16 Record
on:
  workflow_dispatch: # Allows you to run this manually from the Actions tab

jobs:
  android-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg x11-utils

      - name: Run Emulator and Record
        uses: ReactiveCircus/android-emulator-runner@v2
        with:
          api-level: 36
          target: google_apis
          arch: x86_64
          force-avd-creation: true
          # Optimized for Ubuntu/KVM performance
          emulator-options: >-
            -no-window 
            -gpu swiftshader_indirect 
            -noaudio 
            -no-boot-anim 
            -memory 3072 
            -no-snapshot
          disable-animations: true
          script: |
            # 1. Wait for basic adb connectivity
            adb wait-for-device
            
            # 2. Start FFmpeg recording from Xvfb display :99
            # We use a 1280x720 canvas to match standard emulator scales
            echo "Recording started on display :99..."
            ffmpeg -y -f x11grab -video_size 1280x720 -i :99.0 \
              -codec:v libx264 -pix_fmt yuv420p -r 24 test_output.mp4 &
            FFMPEG_PID=$!

            # 3. Wait for the system to actually be usable (The 'Home' screen)
            echo "Waiting for Android Home Screen..."
            timeout 300 adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 5; done'
            
            # --- START YOUR ACTIONS HERE ---
            # Example: Unlock screen and wait
            adb shell input keyevent 82 
            sleep 10
            # Run your tests or scripts
            ./gradlew connectedCheck || EXIT_CODE=$?
            # --- END YOUR ACTIONS HERE ---

            # 4. Gracefully stop recording
            echo "Finalizing video..."
            kill -2 $FFMPEG_PID
            wait $FFMPEG_PID || true
            
            exit ${EXIT_CODE:-0}

      - name: Upload Video
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: emulator-video-api36
          path: test_output.mp4
          retention-days: 5
          
