name: Android Emulator Video Capture

on:
  workflow_dispatch:

jobs:
  emulator-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install system image + emulator
        run: |
          sdkmanager --install "system-images;android-35;google_apis;x86_64" "platforms;android-35" "platform-tools" "emulator"

      - name: Create AVD
        run: |
          echo "no" | avdmanager create avd -n test_avd \
            -k "system-images;android-35;google_apis;x86_64" \
            --device "pixel_5"
          emulator -list-avds

      - name: Add emulator to PATH
        run: echo "$ANDROID_HOME/emulator" >> $GITHUB_PATH

      - name: Start emulator
        run: |
          nohup xvfb-run -a emulator -avd test_avd -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect &
          adb wait-for-device
          until adb shell getprop sys.boot_completed | grep -q "1"; do sleep 5; done

      - name: Capture 20s video
        run: |
          adb shell screenrecord --time-limit 20 /sdcard/demo.mp4
          adb pull /sdcard/demo.mp4 demo.mp4

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: emulator-video
          path: demo.mp4
