name: Android Emulator Video Capture

on:
  workflow_dispatch:   # run manually

jobs:
  emulator-test:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Install required packages
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils \
              xvfb x11-utils imagemagick

      # 3. Set up JDK
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 4. Set up Android SDK
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      # 5. Install system image for Android 15 (API 35) + emulator
      - name: Install system image
        run: |
          sdkmanager --install "system-images;android-35;google_apis;x86_64"
          sdkmanager --install "platforms;android-35"
          sdkmanager --install "platform-tools"
          sdkmanager --install "emulator"

      # 6. Create AVD
      - name: Create AVD
        run: |
          echo "no" | avdmanager create avd -n test_avd -k "system-images;android-35;google_apis;x86_64" --device "pixel_5"

      # 7. Add emulator to PATH
      - name: Add emulator to PATH
        run: echo "$ANDROID_HOME/emulator" >> $GITHUB_PATH

      # 8. Start emulator with xvfb
      - name: Start emulator
        run: |
          nohup xvfb-run -a emulator -avd test_avd -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect &
          adb wait-for-device
          # wait until boot completed
          until adb shell getprop sys.boot_completed | grep -q "1"; do sleep 5; done

      # 9. Capture 20-second video
      - name: Capture video
        run: |
          adb shell screenrecord --time-limit 20 /sdcard/demo.mp4
          adb pull /sdcard/demo.mp4 demo.mp4

      # 10. Upload artifact
      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        with:
          name: emulator-video
          path: demo.mp4
