name: Build Android libtcc.so
on: workflow_dispatch

jobs:
  build-ndk-shared:
    runs-on: ubuntu-latest
    steps:
      # CRITICAL: This pulls the TCC source code into the runner
      - name: Checkout TCC
        run: git clone https://repo.or.cz/tinycc.git .

      - name: Compile libtcc.so for aarch64
        run: |
          # Use the NDK already installed on the GitHub runner
          # Path is usually /usr/local/lib/android/sdk/ndk-bundle or similar
          export NDK_PATH=$ANDROID_NDK_HOME
          export TOOLCHAIN=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64
          
          # Target settings
          export TARGET=aarch64-linux-android
          export API=21
          export CC=$TOOLCHAIN/bin/$TARGET$API-clang
          export AR=$TOOLCHAIN/bin/llvm-ar
          export STRIP=$TOOLCHAIN/bin/llvm-strip
          
          # Configure and Build
          ./configure \
            --cpu=aarch64 \
            --cc=$CC \
            --ar=$AR \
            --extra-cflags="-fPIC" \
            --enable-shared

          make

          # Rename the executable binary to .so so Android allows execution
          cp tcc libtcc.so
          $STRIP libtcc.so

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tcc-android-bundle
          path: |
            libtcc.so
            include/
