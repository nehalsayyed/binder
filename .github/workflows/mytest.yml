name: Android Emulator Screenshot

on:
  workflow_dispatch:   # run manually

jobs:
  emulator-test:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Install required packages
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils \
              xvfb x11-utils imagemagick

      # 3. Set up JDK
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 4. Set up Android SDK
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      # 5. Install system image for Android 15 (API 35)
      - name: Install system image
        run: |
          sdkmanager --install "system-images;android-35;google_apis;x86_64"
          sdkmanager --install "platforms;android-35"
          sdkmanager --install "platform-tools"
          sdkmanager --install "emulator"

      # 6. Create AVD
      - name: Create AVD
        run: |
          echo "no" | avdmanager create avd -n test_avd -k "system-images;android-35;google_apis;x86_64" --device "pixel_5"

      # 7. Start emulator with xvfb
      - name: Start emulator
        run: |
          nohup xvfb-run -a emulator -avd test_avd -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect &
          # wait for boot
          adb wait-for-device
          adb shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'

      # 8. Capture screenshot
      - name: Capture screenshot
        run: |
          adb exec-out screencap -p > screenshot.png

      # 9. Upload artifact
      - name: Upload screenshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: emulator-screenshot
          path: screenshot.png
