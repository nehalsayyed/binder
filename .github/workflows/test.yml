name: Install Android Studio (Snap) & Record UI

on:
  workflow_dispatch:

jobs:
  android-studio-video:
    # Use a larger runner if possible, or expect long run times / potential failures.
    runs-on: ubuntu-latest
    timeout-minutes: 60 # Set a long timeout for the entire job

    steps:
      - name: Install Dependencies
        run: |
          # Install Xvfb and ffmpeg for screen recording
          sudo apt-get update
          sudo apt-get install -y xvfb ffmpeg
          
          # Install snapd (it's usually pre-installed but good to ensure)
          sudo apt-get install -y snapd
          sudo snap install core
          
          # Install Android Studio via Snap (using --classic is essential)
          # This command is often very slow (~5-10 minutes minimum)
          echo "Installing Android Studio via snap. This may take a while..."
          sudo snap install android-studio --classic
          
          # Ensure snap binaries are in the path for the rest of the job
          export PATH=$PATH:/snap/bin

      - name: Start Xvfb
        run: |
          export DISPLAY=:99
          # Start Xvfb with a common resolution
          Xvfb :99 -screen 0 1920x1080x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          sleep 5 # Give Xvfb time to fully initialize

      - name: Run Android Studio and Record Video
        run: |
          # The name of the snap executable is typically the snap package name
          APP_COMMAND="android-studio"
          VIDEO_DURATION=60 # seconds to record the startup/activity

          # 1. Start ffmpeg recording the Xvfb display in the background
          echo "Starting ffmpeg recording for ${VIDEO_DURATION} seconds..."
          ffmpeg -f x11grab -r 10 -s 1920x1080 -i :99.0 -c:v libx264 -pix_fmt yuv420p output.mp4 &
          FFMPEG_PID=$!
          echo "FFMPEG_PID=$FFMPEG_PID" >> $GITHUB_ENV
          sleep 1 # Give ffmpeg a moment to start

          # 2. Start the Android Studio application
          # The first run can take a very long time to extract and set up.
          echo "Starting Android Studio..."
          $APP_COMMAND &

          # 3. Wait for the application to run and actions to be recorded
          echo "Recording startup activity for ${VIDEO_DURATION} seconds..."
          sleep $VIDEO_DURATION

          # 4. Stop the recording gracefully
          kill $FFMPEG_PID
          sleep 3 # Give ffmpeg time to finalize the video file

      - name: Upload Video Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-studio-snap-video
          path: output.mp4
          retention-days: 7
          
